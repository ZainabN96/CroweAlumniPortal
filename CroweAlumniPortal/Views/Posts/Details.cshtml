@model CroweAlumniPortal.Models.Post

@{
    ViewData["Title"] = "Post Details";
    string fn = ViewBag.AuthorFirstName as string;
    string ln = ViewBag.AuthorLastName as string;
    string dp = ViewBag.AuthorPic as string;

    string Initials(string a, string b)
    {
        a = string.IsNullOrWhiteSpace(a) ? "" : a.Trim();
        b = string.IsNullOrWhiteSpace(b) ? "" : b.Trim();
        if (a == "" && b == "") return "?";
        var i1 = a != "" ? char.ToUpper(a[0]).ToString() : "";
        var i2 = b != "" ? char.ToUpper(b[0]).ToString() : "";
        return (i1 + i2).Trim();
    }
}

<div class="container py-4" id="postDetail" data-post-id="@Model.Id">
    <div class="card shadow-sm mb-3 p-5">
        <div class="card-body">

            <!-- FB-like author header -->
            <div class="d-flex align-items-center mb-3">
                @if (!string.IsNullOrWhiteSpace(dp))
                {
                    <img src="@dp" class="rounded-circle" style="width:44px;height:44px;object-fit:cover;" alt="author">
                }
                else
                {
                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                         style="width:44px;height:44px;font-weight:600;">
                        @Initials(fn, ln)
                    </div>
                }
                <div class="ms-2">
                    <div class="fw-semibold">@($"{fn} {ln}".Trim())</div>
                    <div class="text-muted small">@Model.CreatedOn.ToString("MMM dd, yyyy hh:mm tt")</div>
                </div>
                @if ((ViewBag.IsAdmin as bool?) == true)
                {
                    <div class="ms-auto dropdown">
                        <a class="text-muted" data-bs-toggle="dropdown" aria-expanded="false" title="More">
                            <i class="bi bi-three-dots-vertical"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item btn-soft-delete" href="#" data-id="@Model.Id">
                                    Delete
                                </a>
                            </li>
                        </ul>
                    </div>
                }
            </div>

            <h3 class="mb-2">@Model.Title</h3>

            @if (!string.IsNullOrWhiteSpace(Model.Body))
            {
                <div class="mb-3">@Html.Raw((Model.Body ?? "").Replace("\n", "<br/>"))</div>
            }

            @if (!string.IsNullOrWhiteSpace(Model.MediaPath))
            {
                if ((Model.MediaType ?? "").ToLower() == "image")
                {
                    <img class="img-fluid rounded" src="@Model.MediaPath" alt="media" />
                }
                else if ((Model.MediaType ?? "").ToLower() == "video")
                {

                    <video class="w-100 rounded" src="@Model.MediaPath" controls></video>
                }
                else
                {

                    <p><a class="ms-5 me-5" href="@Model.MediaPath" target="_blank">Attachment</a></p>
                }
            }

            <hr />

            <div class="d-flex align-items-center gap-2 mb-2">
                <button id="btnLike" class="btn btn-sm btn-outline-primary" data-liked="0">
                    <i class="bi bi-hand-thumbs-up"></i> Like
                </button>
                <span id="likeCount" class="text-muted small">0 likes</span>
            </div>
            
            <div class="d-flex gap-2">
                <input type="text" id="newComment" class="form-control form-control-sm" placeholder="Write a comment..." />
                <button id="btnAddComment" class="btn btn-sm btn-primary">Post</button>
            </div>
                
            <div id="commentsWrap" class="mt-2">
                <div class="text-muted small">Loading comments…</div>
            </div>

        </div>
    </div>
</div>
@section Scripts {
    <script src="~/assets/js/jquery-3.5.1.js"></script>
    <script>
        const postId = +document.getElementById("postDetail").dataset.postId;

        function refreshLikeState(){
          $.get(`/api/posts/${postId}/like/state`)
            .done(s => {
              const count = s.likeCount ?? 0;
              const liked = !!(s.isLiked ?? false);
              $("#likeCount").text(`${count} ${count === 1 ? "like" : "likes"}`);
              $("#btnLike")
                .attr("data-liked", liked ? "1" : "0")
                .toggleClass("btn-primary", liked)
                .toggleClass("btn-outline-primary", !liked)
                .html(`<i class="bi bi-hand-thumbs-up${liked ? "-fill" : ""}"></i> Like`);
            });
        }

        function loadComments(){
          $("#commentsWrap").html(`<div class="text-muted small">Loading comments…</div>`);
          $.get(`/api/posts/${postId}/comments`)
            .done(list => {
              if (!Array.isArray(list) || list.length === 0){
                $("#commentsWrap").html(`<div class="text-muted small">No comments yet.</div>`);
                return;
              }
              const html = list.map(renderComment).join("");
              $("#commentsWrap").html(html);
            })
            .fail(()=> $("#commentsWrap").html(`<div class="text-danger small">Failed to load comments.</div>`));
        }

        function initialsFromName(name){
          const parts = (name||"").trim().split(/\s+/).filter(Boolean);
          if (parts.length === 0) return "?";
          if (parts.length === 1) return parts[0][0].toUpperCase();
          return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
        }
        function timeAgo(iso){
          if(!iso) return "";
          const then = new Date(iso.endsWith("Z") ? iso : iso + "Z");
          const diff = (Date.now() - then.getTime())/1000;
          if (diff < 60) return "Just now";
          const m = Math.floor(diff/60);
          if (m < 60) return `${m} min ago`;
          const h = Math.floor(m/60);
          if (h < 24) return `${h} h ago`;
          const d = Math.floor(h/24);
          if (d < 7) return `${d} d ago`;
          return then.toLocaleDateString();
        }
        function renderComment(c){
          const name = `${c.author?.firstName ?? ""} ${c.author?.lastName ?? ""}`.trim() || "Unknown";
          const pic  = c.author?.profilePicturePath;
          const av = pic
            ? `<img src="${pic}" class="rounded-circle" style="width:28px;height:28px;object-fit:cover;">`
            : `<div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                 style="width:28px;height:28px;font-size:12px;font-weight:600;">${initialsFromName(name)}</div>`;
          const when = c.createdOn ? timeAgo(c.createdOn) : "";
          const body = (c.body || "").replace(/\n/g,"<br/>");
          return `
            <div class="d-flex align-items-start mb-3">
              ${av}
              <div class="ms-2 bg-light rounded" style="max-width:100%;">
                <div class="fw-semibold small">${name} <span class="text-muted">· ${when}</span></div>
                <div class="small">${body}</div>
              </div>
            </div>`;
        }

        $(function(){
          // initial
          refreshLikeState();
          loadComments();

          // like toggle
          $("#btnLike").on("click", function(){
            $.post(`/api/posts/${postId}/like/toggle`)
              .done(()=> refreshLikeState())
              .fail(xhr => alert(xhr.responseText || "Failed to like."));
          });

          // add comment
          $("#btnAddComment").on("click", function(){
            const text = ($("#newComment").val() || "").trim();
            if(!text) return;
            $.ajax({
              url: `/api/posts/${postId}/comment`,
              method: "POST",
              contentType: "application/json",
              data: JSON.stringify({ body: text })
            })
            .done(res => {
              const html = renderComment(res);
              const $wrap = $("#commentsWrap");
              if ($wrap.find(".text-muted.small").length) $wrap.empty();
              $wrap.append(html);
              $("#newComment").val("");
            })
            .fail(xhr => alert(xhr.responseText || "Failed to add comment."));
          });
        });
           $(document).on("click", ".btn-soft-delete", function (e) {
          e.preventDefault();
          const postId = $(this).data("id");
          if (!postId) return;
          if (!confirm("Are you sure you want to remove this post? This hides it from everyone.")) return;

          $.post(`/api/posts/${postId}/soft-delete`)
            .done(() => {
              alert("Post removed.");
              window.location.href = "/Dashboard/Dashboard"; 
            })
            .fail(xhr => {
              alert(xhr.responseText || "Could not delete post.");
            });
        });
    </script>
}